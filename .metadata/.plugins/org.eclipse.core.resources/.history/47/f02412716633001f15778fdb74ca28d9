<%@page import="com.spring5legacy.mypro00.service.MyBoardService"%>
<%@page import="com.fasterxml.jackson.annotation.JsonInclude.Include"%>
<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
    
   
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/fmt" prefix="fmt"%>
<%@ taglib uri="http://www.springframework.org/security/tags" prefix="security" %>

<c:set var="contextPath" value="${pageContext.request.contextPath }" />
<security:authentication property="principal" var="principal"/>
    
<%@ include file="../myinclude/myheader.jsp" %>


<style>
    .fileUploadResult ul li { list-style: none; }
</style>

   <div id="page-wrapper">
     <div class="row">
       <div class="col-lg-12">
           <h3 class="page-header">Board - register</h3>
       </div><%-- /.col-lg-12 --%>
     </div><%-- /.row --%>
       <div class="row">
         <div class="col-lg-12">
           <div class="panel panel-default">
             <div class="panel-heading"> <h4>게시글 등록</h4> </div> <%-- /.panel-heading --%>
               <div class="panel-body">
                      
					<form role="form" method="post" 
						  action="${contextPath }/myboard/register"
					      onsubmit="return checkValue(event)"
					      id="frmRegister">
					      
						<div class="form-group">
                 			<label>글제목</label>
                       		<input class="form-control" placeholder="글제목을 입력하십시오" name="btitle">
                 	    </div>
                 	    
						<div class="form-group">
                            <label>글내용</label>
                            <textarea class="form-control" rows="3" placeholder="글내용을 입력하십시오" name="bcontent"></textarea>
                        </div>
                        
               			<div class="form-group">
                       		<label>작성자</label>
                            <input class="form-control" value="${principal.username}" name="bwriter" readonly>
                        </div>
                        
                        <button type="submit" class="btn btn-primary" data-oper="register">등록</button>
                        <button type="button" class="btn btn-warning" data-oper="list">취소</button>
                        <%--<input type="hidden" name="${_csrf.parameterName }" value="${_csrf.token}">--%>
                        <security:csrfInput/>
                        
					</form>                      
                </div><%-- /.panel-body --%>
             </div><%-- /.panel --%>
          </div><%-- /.col-lg-12 --%>
       </div><%-- /.row --%>
       
              <div class="row">
         <div class="col-lg-12">
           <div class="panel panel-default">
             <div class="panel-heading"> <h4>파일 첨부</h4> </div> <%-- /.panel-heading --%>
               <div class="panel-body">
               
                <div class="form-group uploadDiv">
   					<input type="file" class="btn btn-primary fileInput" id="fileInput" name="fileInput" multiple>
				</div>
				<div class="fileUploadResult">
					<ul>
						<%-- 업로드 후 처리결과가 표시될 영역 --%>
					</ul>
				</div>
                     	 
                </div><%-- /.panel-body --%>
             </div><%-- /.panel --%>
          </div><%-- /.col-lg-12 --%>
       </div><%-- /.row --%>
    </div><%-- /#page-wrapper --%>
   
<script>

	var frmRegister = $("#frmRegister");
	var fileUploadResultUL = $(".fileUploadResult ul");
 
	function checkValue(event) {
		var btitle = document.querySelector("[name='btitle']");
        var bcontent = document.querySelector("[name='bcontent']");
        var bwriter = document.querySelector("[name='bwriter']");
        
        if (!btitle.value.trim()) {
            event.preventDefault();
            alert("글제목을 입력하십시오.");
            btitle.focus();
            return false;
        }

        if (!bcontent.value.trim()) {
            event.preventDefault();
            alert("글내용을 입력하십시오.");
            bcontent.focus();
            return false;
        }

        if (!bwriter.value.trim()) {
            event.preventDefault();
            alert("작성자를 입력하십시오.");
            bwriter.focus();
            return false;
        }
        

	}
	
	<%-- 파일 크기 및 확장자 제한 검사 함수 --%>
	function checkUploadFile(fileName, fileSize){
		
		var allowedMaxSize = 1048576;
		var regExpForbiddenFile = /(^\.[a-zA-z0-9]+$)|(^[^\.]+$)|(.+\.(exe|sh|c|dll|alz|zip|tar|7z)$)/i;
		
		if (fileSize > allowedMaxSize) {
			alert("업로드 파일의 크기는 1MB보다 작아야 합니다.");
			return false;
		}
		
		if (regExpForbiddenFile.test(fileName)) {
			alert("해당 파일은 업로드 할 수 없는 유형입니다.")
			return false;
		}
		return true;
	}

	<%-- 업로드 결과 표시 함수 --%>
	function showUploadRsult(uploadResult){
		
		var htmlStr = "";
		
		if (uploadResult == null || uploadResult.length == 0) {
			htmlStr="<li>첨부파일이 없습니다.</li>"
		    fileUploadResultUL.html(htmlStr);
			return;
		}
		
		var fullFileName = null;
		
		$(uploadResult).each(function(i, attachFile){

			fullFileName = encodeURI(attachFile.repoPath + "/" + 
									 attachFile.uploadPath + "/" +
									 attachFile.uuid + "_" + attachFile.fileName);
		
			if (attachFile.fileType == "F") {
				htmlStr
				+="<li data-uploadpath='" + attachFile.uploadPath + "'data-uuid='" + attachFile.uuid + "'data-filename='" + attachFile.fileName + "'data-filetype='F'>"
				+ "    <img src='${contextPath}/resources/icons/icon-attach.png' style='width:50px;'/>"
				+ "    &emsp;" + attachFile.fileName
	            + "    <span class='glyphicon glyphicon-remove-sign' data-filename='" + fullFileName + "'"
	            + "          data-filetype='F' style='color:red;'></span>"
				+ "</li>"
			} else {
				var thumbnail = encodeURI(attachFile.repoPath + "/" + 
										  attachFile.uploadPath + "/s_" +
										  attachFile.uuid + "_" + attachFile.fileName);
				htmlStr
				+="<li data-uploadpath='" + attachFile.uploadPath + "'data-uuid='" + attachFile.uuid + "'data-filename='" + attachFile.fileName + "'data-filetype='I'>"
				+ "    <img src='${contextPath}/displayThumbnail?thumbnail=" + thumbnail + "' style='width:50px;'/>"
				+ "    &emsp;" + attachFile.fileName
	            + "    <span class='glyphicon glyphicon-remove-sign' data-filename='" + thumbnail + "'"
	            + "          data-filetype='I' style='color:red;'></span>"

				+ "</li>"
			}
			
		});
		fileUploadResultUL.append(htmlStr);
		
	}

	var _csrfHeaderName = "${_csrf.headerName}";
	var _csrfToken = "${_csrf.token}";
	
	$("#fileInput").on("change",function(){
		
	    var fileInput = $("#fileInput")[0];
	    var uploadFiles = fileInput.files;
	    console.log(uploadFiles);
	    
	    var formData = new FormData();
	    
	    for(var i = 0 ; i < uploadFiles.length ; i++) {
	    	
	    	if (!checkUploadFile(uploadFiles[i].name, uploadFiles[i].size)) {
	    		console.log("파일이름: " + uploadFiles[i].name);
	    		console.log("파일이름: " + uploadFiles[i].size);
	    		
	    		$("#fileInput").val("");
				return;
			}
	    	
	    	formData.append("uploadFiles", uploadFiles[i])
	    }
	    
	    $.ajax({
	    	type: "post", 
	    	url: "${contextPath}/doFileUploadByAjax",
	    	data: formData,
	    	contentType: false,  
	    	processData: false,  
	    	dataType: "json",
	    	beforeSend: function(xhr){
	    		xhr.setRequestHeader(_csrfHeaderName, _csrfToken);
	    	},
	    	success: function(uploadResult, status){
	    		console.log(uploadResult);
	    		$("#fileInput").val("");
	    		showUploadRsult(uploadResult);
	    	}
	    });
	});
	
	<%-- 클릭시 삭제 이벤트 --%>
	$(".fileUploadResult ul").on("click", "li span",function(){
		var fileName = $(this).data("filename");
		var fileType = $(this).data("filetype");
		var fileLi = $(this).parent();
		
		$.ajax({
			type: "post",
			url: "${contextPath}/deleteFile",
			data:{fileName: fileName, fileType: fileType},
			dataType: "text",
			beforeSend: function(xhr){
				xhr.setRequestHeader(_csrfHeaderName, _csrfToken);
			},
			success: function(result){
				if(result == "DelSuccess"){
					alert("파일이 삭제되었습니다.");
					fileLi.remove();
				} else {
					if (confirm("파일이 존재하지 않습니다. 해당 항목을 삭제하시겠습니까?")) {
						fileLi.remove();
					}
				}
			},
			error: function(xhr,status,e){
					alert("서버 장애");
					console.log(e);
					
					if (confirm("파일이 존재하지 않습니다. 해당 항목을 삭제하시겠습니까?")) {
						fileLi.remove();
					}
			}
		});
	});
	
	<%-- 취소 버튼 클릭 처리 --%>
	
	$("button").on("click",function(){	
		
		if($(this).data("oper") == "list"){
			
			frmRegister.empty();
			fileUploadResultUL.empty();
			location.href = "${contextPath}/myboard/list";			
			return;
		}

			var attachFileInputHTML = "";
			
			// 첨부파일이 없으면 실행되지 않음
			
			$("div.fileUploadResult ul li").each(function(i, objLi){
				var attachLi = $(objLi);
				
				attachFileInputHTML
				+= "<input type='hidden' name='attachFileList["+i+"].uuid' value='"+attachLi.data("uuid") + "'>"
				+ "<input type='hidden' name='attachFileList["+i+"].uploadPath' value='"+attachLi.data("uploadpath") + "'>"
				+ "<input type='hidden' name='attachFileList["+i+"].fileName' value='"+attachLi.data("filename") + "'>"
				+ "<input type='hidden' name='attachFileList["+i+"].fileType' value='"+attachLi.data("filetype") + "'>";
			});
			// alert(attachFileInputHTML);
			if (attachFileInputHTML) {
				frmRegister.append(attachFileInputHTML);
			}
	});
	
</script>
<%@ include file="../myinclude/myfooter.jsp" %>