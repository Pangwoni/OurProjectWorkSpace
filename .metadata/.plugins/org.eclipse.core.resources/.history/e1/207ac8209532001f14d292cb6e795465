<%@page import="com.spring5legacy.mypro00.service.MyBoardService"%>
<%@page import="com.fasterxml.jackson.annotation.JsonInclude.Include"%>
<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
    
   
    <%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
     <%@ taglib uri="http://java.sun.com/jsp/jstl/fmt" prefix="fmt"%>
    
<c:set var="contextPath" value="${pageContext.request.contextPath }" />
    
<%@ include file="../myinclude/myheader.jsp" %>



<style>
    .fileUploadResult ul li { list-style: none; }
</style>

        <div id="page-wrapper">
            <div class="row">
                <div class="col-lg-12">
                    <h3 class="page-header">Board - Modify</h3>
                </div>
                <!-- /.col-lg-12 -->
            </div>
            <!-- /.row -->
            <div class="row">
                <div class="col-lg-12">
                    <div class="panel panel-default">
                        <div class="panel-heading"> <h4>${myBoard.bno}번 게시물 수정</h4> </div> <%-- /.panel-heading --%>
                        <div class="panel-body">
                           
 							<form role="form" id="frmModify" method="post" action="${contextPath }/myboard/modify"
 							      onsubmit="checkValue(event);">
 							      	
								<div class="form-group">
                             		<label>글제목</label>
                                   	<input class="form-control" id="btitle" value='<c:out value="${myBoard.btitle}"/>' name="btitle">
                                </div>
 								<div class="form-group">
                                    <label>글내용</label>
                                    <textarea class="form-control" id="bcontent" rows="3" name="bcontent"
                                    ><c:out value="${myBoard.bcontent}"/></textarea>
                                </div>
                     			<div class="form-group">
                             		<label>작성자</label>
                                   	<input class="form-control" id="bwriter" value='<c:out value="${myBoard.bwriter}"/>' 
                                   		   name="bwriter" readonly="readonly">
                                </div>
                                <button type="submit" class="btn btn-primary" id ="btnModify" data-oper="modify">수정</button>                               
                                <button type="button" class="btn btn-danger" id="btnDelete" data-oper="delete">삭제</button>
                                <button type="button" class="btn btn-warning" id="btnToList" data-oper="list">취소</button>
                                <input type="hidden" id = "bno" name="bno" value="${myBoard.bno}"  />
                                <input type="hidden" id="pageNum" name="pageNum" value="${myBoardPaging.pageNum}">
								<input type="hidden" id="scope" name="scope" value="${myBoardPaging.scope}">
								<input type="hidden" id="keyword" name="keyword" value="${myBoardPaging.keyword}">		
								<input type="hidden" id="rowAmountPerPage" name="rowAmountPerPage" value="${myBoardPaging.rowAmountPerPage}">
								<input type="hidden" id="startDate" name="startDate" value="${myBoardPaging.startDate}">
								<input type="hidden" id="endDate" name="endDate" value="${myBoardPaging.endDate}">
								<input type="hidden" name="${_csrf.parameterName }" value="${_csrf.token}">
							</form>		
                            
                        </div>
                        <!-- /.panel-body -->
                    </div>
                    <!-- /.panel -->
                </div>
                <!-- /.col-lg-12 -->
            </div>
			<!-- /.row -->
			
		<div class="row">
         <div class="col-lg-12">
           <div class="panel panel-default">
             <div class="panel-heading"> <h4>첨부 파일</h4> </div> <%-- /.panel-heading --%>
               <div class="panel-body">
               <div class="form-group uploadDiv">
   					<input type="file" class="btn btn-primary fileInput" id="fileInput" name="fileInput" multiple>
				</div>
				<div class="fileUploadResult">
					<ul>
<c:choose>
	<c:when test="${empty myBoard.attachFileList }">
		<li style="font-size: 12pt">첨부파일이 없습니다</li>
	</c:when>
	
	<c:otherwise>
		<c:forEach var="attachFile" items="${myBoard.attachFileList }">
		<c:set var="fullFileName" value="${attachFile.repoPath}/${attachFile.uploadPath}/${attachFile.uuid}_${attachFile.fileName}"/>
			<c:choose>
				<c:when test="${attachFile.fileType == 'F' }">
			<li class="attachLi" 
				data-repopath ="${attachFile.repoPath }"
			    data-uploadpath="${attachFile.uploadPath }"
			    data-uuid="${attachFile.uuid }"
			    data-filename="${attachFile.fileName }"
			    data-filetype="${attachFile.fileType }">
				<img src='${contextPath}/resources/icons/icon-attach.png' style='width:50px;'/>
				    &emsp;${attachFile.fileName }
				<span class='glyphicon glyphicon-remove-sign' data-filename="${fullFileName}"
	                  data-filetype='F' style='color:red;'></span>
			</li>
				</c:when>
				
				<c:when test="${attachFile.fileType == 'I' }"> 
			<c:set var="thumbnail" value="${attachFile.repoPath}/${attachFile.uploadPath}/${attachFile.uuid}_${attachFile.fileName}"/>
			<li class="attachLi" 
			    data-repopath ="${attachFile.repoPath }"
			    data-uploadpath="${attachFile.uploadPath }"
			    data-uuid="${attachFile.uuid }"
			    data-filename="${attachFile.fileName }"
			    data-filetype="${attachFile.fileType }">
				<img src="${contextPath}/displayThumbnail?thumbnail=${thumbnail}" style="width:50px;"/>
				    &emsp;${attachFile.fileName }
				<span class='glyphicon glyphicon-remove-sign' data-filename="${thumbnail}"
	                  data-filetype='F' style='color:red;'></span>
			</li>			
				</c:when>
			
			</c:choose>
		</c:forEach>
	</c:otherwise>
</c:choose>		
				    </ul>
				 </div><!-- /.fileUploadResult -->
               </div><!-- /.panel-body -->
             </div><!-- /.panel -->
          </div><!-- /.col-lg-12 -->
        </div><!-- /.row -->
      </div><!-- /#page-wrapper -->
        
<script>
	
    
 
	function checkValue(event) {
		
		if ($("#btitle").length <= 0) {
			return;
		}
	
		var btitle = document.getElementById("btitle").value;
	    var bcontent = document.getElementById("bcontent").value;
	    var bwriter = document.getElementById("bwriter").value;		

        if (!btitle.trim()) {
            event.preventDefault();
            alert("글제목을 입력하십시오.");
            btitle.focus();
            return false;
        }

        if (!bcontent.trim()) {
            event.preventDefault();
            alert("글내용을 입력하십시오.");
            bcontent.focus();
            return false;
        }

        if (!bwriter.trim()) {
            event.preventDefault();
            alert("작성자를 입력하십시오.");
            bwriter.focus();
            return false;
        }       
	}

    $("button").on("click", function() {
        var oper = $(this).data("oper");
        var frmModify = $("#frmModify");

        if (oper == "list") {
        	
        	var pageNumInput = $("input[id='pageNum']").clone();
        	var rowAmountPerPage = $("input[id='rowAmountPerPage']").clone();
            var scopeInput = $("#scope").clone();
            var keywordInput = $("#keyword").clone();
        	
        	frmModify.empty();
        	
        	frmModify.append(scopeInput);
        	frmModify.append(keywordInput);
        	frmModify.append(pageNumInput);
        	frmModify.append(rowAmountPerPage);

        	
        	/* frmModify.find("#btitle").remove();
        	frmModify.find("#bcontent").remove();
        	frmModify.find("#bwriter").remove(); */
        	
        	frmModify.attr("action", "${contextPath}/myboard/list").attr("method","get");
        	
        	// frmModify.attr("action", "${contextPath}/myboard/list");
        	// frmModify.attr("method","get");
        	
        } else if (oper == "delete") {
            // frmModify.attr("action", "${contextPath}/myboard/delete");
            frmModify.attr("action", "${contextPath}/myboard/remove");
        } else {
            var fileLi = $(".fileUploadResult ul li");
        	
            if (!fileLi.data("filename")) {
        		fileLi.remove();
        	};
        	var attachFileInputHTML = "";
        	
        	$("div.fileUploadResult ul li").each(function(i, objLi){
				var attachLi = $(objLi);
				
				attachFileInputHTML
				+= "<input type='hidden' name='attachFileList["+i+"].uuid' value='"+attachLi.data("uuid") + "'>"
				+ "<input type='hidden' name='attachFileList["+i+"].uploadPath' value='"+attachLi.data("uploadpath") + "'>"
				+ "<input type='hidden' name='attachFileList["+i+"].fileName' value='"+attachLi.data("filename") + "'>"
				+ "<input type='hidden' name='attachFileList["+i+"].fileType' value='"+attachLi.data("filetype") + "'>";
			});
			// alert(attachFileInputHTML);
			if (attachFileInputHTML) {
				frmModify.append(attachFileInputHTML);
			}
			
            return;
        }
        
	    frmModify.submit();
    });
    
<%-- 첨부파일 처리 시작 --%>

<%-- 업로드 결과 표시 함수 --%>
var fileUploadResultUL = $(".fileUploadResult ul");





function showUploadRsult(uploadResult){

    var fileLi = $(".fileUploadResult ul li");
	
    if (!fileLi.data("filename")) {
		fileLi.remove();
	};
		
	
	var fileUploadResultUL = $(".fileUploadResult ul");
	var htmlStr = "";
	
	var fullFileName = null;
	
	$(uploadResult).each(function(i, attachFile){

		fullFileName = encodeURI(attachFile.repoPath + "/" + 
								 attachFile.uploadPath + "/" +
								 attachFile.uuid + "_" + attachFile.fileName);
	
		if (attachFile.fileType == "F") {
			htmlStr
			+="<li data-uploadpath='" + attachFile.uploadPath + "'data-uuid='" + attachFile.uuid + "'data-filename='" + attachFile.fileName + "'data-filetype='F'>"
			+ "    <img src='${contextPath}/resources/icons/icon-attach.png' style='width:50px;'/>"
			+ "    &emsp;" + attachFile.fileName
            + "    <span class='glyphicon glyphicon-remove-sign' data-filename='" + fullFileName + "'"
            + "          data-filetype='F' style='color:red;'></span>"
			+ "</li>"
		} else {
			var thumbnail = encodeURI(attachFile.repoPath + "/" + 
									  attachFile.uploadPath + "/s_" +
									  attachFile.uuid + "_" + attachFile.fileName);
			htmlStr
			+="<li data-uploadpath='" + attachFile.uploadPath + "'data-uuid='" + attachFile.uuid + "'data-filename='" + attachFile.fileName + "'data-filetype='I'>"
			+ "    <img src='${contextPath}/displayThumbnail?thumbnail=" + thumbnail + "' style='width:50px;'/>"
			+ "    &emsp;" + attachFile.fileName
            + "    <span class='glyphicon glyphicon-remove-sign' data-filename='" + thumbnail + "'"
            + "          data-filetype='I' style='color:red;'></span>"

			+ "</li>"
		}
		
	});
	fileUploadResultUL.append(htmlStr);
	
}

<%-- 파일 크기 및 확장자 제한 검사 함수 --%>
function checkUploadFile(fileName, fileSize){
	
	var allowedMaxSize = 1048576;
	var regExpForbiddenFile = /(^\.[a-zA-z0-9]+$)|(^[^\.]+$)|(.+\.(exe|sh|c|dll|alz|zip|tar|7z)$)/i;
	
	if (fileSize > allowedMaxSize) {
		alert("업로드 파일의 크기는 1MB보다 작아야 합니다.");
		return false;
	}
	
	if (regExpForbiddenFile.test(fileName)) {
		alert("해당 파일은 업로드 할 수 없는 유형입니다.")
		return false;
	}
	return true;
}

// input 초기화를 위해 div 요소의 비어있는  input요소를 복사해서 저장함
var cloneFileInput = $(".uploadDiv").clone();
// clone(): 선택된 요소가 자식 요소를 가지고 있으면, 자식요소가 복사됨
// clone(): 선택된 요소가 자식 요소를 가지고 않으면, 선택된 요소가 복사됨
// console.log("cloneFileInput: " + cloneFileInput.html());
// <input type="file" class = "fileInput" id = "fileInput" name="fileInput" multiple>

<%-- 업로드 처리, 파일 input 요소의 내용이 바뀌면 업로드가 수행되도록 수정--%>
<%-- 업로드 후, 복사된 파일 input으로 파일 input을 초기화 -> 이벤트 위임으로 요소를 선택--%>

$(".uploadDiv").on("change","input[type='file']", function(){
	
    var fileInput = $("#fileInput")[0];
    var uploadFiles = fileInput.files;
    console.log(uploadFiles);
    
    var formData = new FormData();
    
    for(var i = 0 ; i < uploadFiles.length ; i++) {
    	
    	if (!checkUploadFile(uploadFiles[i].name, uploadFiles[i].size)) {
    		console.log("파일이름: " + uploadFiles[i].name);
    		console.log("파일이름: " + uploadFiles[i].size);
    		
    		$("#fileInput").val("");
			return;
		}
    	
    	formData.append("uploadFiles", uploadFiles[i])
    }
    
    $.ajax({
    	type: "post", 
    	url: "${contextPath}/doFileUploadByAjax",
    	data: formData,
    	contentType: false,  
    	processData: false,  
    	dataType: "json",
    	success: function(uploadResult, status){
    		console.log(uploadResult);
    		$("uploadDiv").html(cloneFileInput.html());
    		// $("#fileInput").val("");
    		showUploadRsult(uploadResult);
    	}
    });
});
// #page-wrapper > div:nth-child(3) > div > div > div.panel-body > div.fileUploadResult > ul > li.attachLi > span
<%-- 클릭시 삭제 이벤트 : 화면에 표시되는 부분만 삭제 ( 수정 취소 대비 )--%>

$(".fileUploadResult ul").on("click", "li span",function(){
	var fileName = $(this).data("filename");
	var fileType = $(this).data("filetype");
	
	// var fileLi = $(this).parent();
	var fileLi = $(this).closest("li");
	
	if(confirm("선택한 파일을 삭제하시겠습니까?")){
		fileLi.remove();
	} else {
		if (confirm("파일이 존재하지 않습니다. 해당 항목을 삭제하시겠습니까?")) {
			fileLi.remove();
		}
	}
	
});

</script>
<%@ include file="../myinclude/myfooter.jsp" %>