<%@page import="com.spring5legacy.mypro00.service.MyBoardService"%>
<%@page import="com.fasterxml.jackson.annotation.JsonInclude.Include"%>
<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>

<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/fmt" prefix="fmt"%>
<%@ taglib uri="http://www.springframework.org/security/tags" prefix="security" %>

<c:set var="contextPath" value="${pageContext.request.contextPath }" />

<%@ include file="../myinclude/myheader.jsp"%>

<style>
.commentUL li { list-style: none; }

.bigImageWrapper { position: absolute; display: none; justify-content: center; align-items: center; top: 0%;
				   width: 100%; height: 100%; background-color: lightgray; z-index: 100; }

.txtBoxCmt, .txtBoxComment { overflow: hidden; resize: vertical; min-height: 100px; color: black; }

.bigImage { position: relative; display: flex; justify-content: center; align-items: center; }

.bigImage img { height: 100%; max-width: 100%; width: auto; overflow: hidden }

</style>

<div id="page-wrapper">
	<div class="row">
		<div class="col-lg-12">
			<h3 class="page-header">Board - Detail</h3>
		</div> <%-- /.col-lg-12 --%>
	</div> <%-- /.row --%>
	
	<div class="row">
		<div class="col-lg-12">
			<div class="panel panel-default">
				<div class="panel-heading">
					<h3 style="display: inline-block; margin: 20px; font-weight: bold;">
						<c:out value="${myBoard.bno}" />
					</h3>
					<span style="display: inline-block; font-weight: bold; margin: 23px;"
						class="pull-right">등록일 : <fmt:formatDate
							value="${myBoard.bregDate}" pattern="yyyy/MM/dd" /></span> <span
						style="display: inline-block; font-weight: bold; margin: 23px;" class="pull-right">조회수:
						<c:out value="${myBoard.bviewsCnt }" />
					</span> <span style="display: inline-block; font-weight: bold; margin: 23px;"
						class="pull-right">작성자: <c:out value="${myBoard.bwriter }" />
					</span>

				</div> <%-- /.panel-heading --%>
				<div class="panel-body">

					<div class="form-group">
						<label>글제목</label> <input class="form-control" name="btitle"
							value="<c:out value="${myBoard.btitle}"/>" readonly="readonly">
					</div>
					
					<div class="form-group">
						<label>글내용</label>
						<textarea class="form-control" rows="3" name="bcontent"
							readonly="readonly"><c:out value="${myBoard.bcontent}" /></textarea>
					</div>

					<span style="display: inline-block; margin: 2px 2px 20px;">수정일
						: <fmt:formatDate value="${myBoard.bmodDate}"
							pattern="yyyy/MM/dd hh:mm" />
					</span><br>

					<button type="button" class="btn btn-warning pull-right"
						style="display: inline-block; margin: 0 10px" id="btnToList">목록</button>
						
					<security:authorize access="isAuthenticated()">
						<security:authentication property="principal.username" var="username"/>
						<c:if test="${username == myBoard.bwriter }">
						<button type="button" class="btn btn-primary pull-right" style="display: inline-block;" id="btnToModify">수정</button>
						</c:if>
					</security:authorize>


				</div> <%-- /.panel-body --%>
			</div> <%-- /.panel --%>
		</div> <%-- /.col-lg-12 --%>
	</div> <%-- /.row --%>
	
	<%-- 첨부파일 표시 영역 --%>
	<div class="row">
		<div class="col-lg-12">
			<div class="panel panel-default">
				<div class="panel-heading">
					<h4>첨부 파일</h4>
				</div> <%-- /.panel-heading --%>
				<div class="panel-body">
					<div class="fileUploadResult">
						<ul>
							<c:choose>
								<c:when test="${empty myBoard.attachFileList }">
									<li style="font-size: 12pt">첨부파일이 없습니다</li>
								</c:when>
								<c:otherwise>
									<c:forEach var="attachFile" items="${myBoard.attachFileList }">
										<c:choose>
											<c:when test="${attachFile.fileType == 'F' }">
												<li class="attachLi" data-repopath="${attachFile.repoPath }"
													data-uploadpath="${attachFile.uploadPath }"
													data-uuid="${attachFile.uuid }"
													data-filename="${attachFile.fileName }"
													data-filetype="${attachFile.fileType }"><img
													src='${contextPath}/resources/icons/icon-attach.png'
													style='width: 50px;' /> &emsp;${attachFile.fileName }</li>
											</c:when>

											<c:when test="${attachFile.fileType == 'I' }">
												<c:set var="thumbnail"
													value="${attachFile.repoPath}/${attachFile.uploadPath}/${attachFile.uuid}_${attachFile.fileName}" />
												<li class="attachLi" data-repopath="${attachFile.repoPath }"
													data-uploadpath="${attachFile.uploadPath }"
													data-uuid="${attachFile.uuid }"
													data-filename="${attachFile.fileName }"
													data-filetype="${attachFile.fileType }"><img
													src="${contextPath}/displayThumbnail?thumbnail=${thumbnail}"
													style="width: 50px;" /> &emsp;${attachFile.fileName }</li>
											</c:when>
										</c:choose>
									</c:forEach>
								</c:otherwise>
							</c:choose>
						</ul>
					</div> <%-- /.fileUploadResult --%>
				</div> <%-- /.panel-body --%>
			</div> <%-- /.panel --%>
		</div> <%-- /.col-lg-12 --%>
	</div> <%-- /.row --%>
	
	<%-- 첨부파일 표시 모달 --%>
	<div class="modal fade" id="attachModal" tabindex="-1" role="dialog"
		aria-labelledby="attachModalLabel" aria-hidden="true"
		style="display: none;">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-body" id="attachModal-body">메시지</div>
			</div> <%-- /.modal-content --%>
		</div> <%-- /.modal-dialog --%>
	</div> <%-- 댓글 화면 표시 시작 --%>

	<div class="row">
		<div class="col-lg-12">
			<div class="panel panel-default">
				<div class="panel-heading">
					<p style="margin-bottom: 0px; font-size: 16px;">
						<strong style="padding-top: 2px;"> <span>댓글&nbsp;<c:out
									value="${myBoard.breplyCnt}" />개
						</span> <span>&nbsp;</span>
						<security:authorize access="isAuthenticated()">
							<button type="button" id="btnChgCmtReg" class="btn btn-info btn-sm">댓글 작성</button>
						</security:authorize>
							
							<button type="button" id="btnRegCmt" class="btn btn-warning btn-sm" style="display: none">댓글 등록</button>
							<button type="button" id="btnCancelRegCmt" class="btn btn-danger btn-sm" style="display: none">취소</button>
						</strong>
					</p>
				</div> <%-- /.panel-heading --%>

				<div class="panel-body">
				
					<%-- 댓글 입력창 div 시작 --%>
					<security:authorize access="isAuthenticated()">
					<div class="form-group" style="margin-bottom: 5px;">
						<textarea class="form-control txtBoxCmt" name="rcontent"
							placeholder="댓글작성을 원하시면,&#10;댓글 작성 버튼을 클릭해주세요."
							readonly="readonly"></textarea>
					</div>
					</security:authorize>
					<hr style="margin-top: 10px; margin-bottom: 10px;">
					<%-- 댓글 입력창 div 끝 --%>
					
					<ul class="commentUL">
						<%-- 댓글 목록 표시 영역 - JavaScript로 내용이 생성되어 표시됩니다.--%>
					</ul> <%-- /.chat --%>
				</div> <%-- /.panel-body --%>

				<div class="panel-footer text-center" id="showCmtPagingNums" >
					<%-- 댓글 목록의 페이징 번호 표시 영역 - JavaScript로 내용이 생성되어 표시됩니다.--%>
				</div>
				
			</div> <%-- /.panel --%>
		</div> <%-- .col-lg-12 --%>
	</div> <%-- .row : 댓글 화면 표시 끝 --%>
	
	<%-- 댓글 페이징 데이터 저장 form --%>
	<form id="frmCmtPagingValue">
		<input type='hidden' name='pageNum' value='' /> 
		<input type='hidden' name='rowAmountPerPage' value='' />
	</form>
</div> <%-- /#page-wrapper --%>

<%-- 모달 처리 결과 --%>
<div class="modal fade" id="myModal" tabindex="-1" role="dialog"
	aria-labelledby="myModalLabel" aria-hidden="true"
	style="display: none;">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal"
					aria-hidden="true">×</button>
				<h4 class="modal-title" id="myModalLabel">처리 결과</h4>
			</div>
			<div class="modal-body" id="my-modal-body"></div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
			</div>
		</div> <%-- /.modal-content --%>
	</div> <%-- /.modal-dialog --%>
</div>



<form id="frmSendValue">
	<input type="hidden" id="pageNum" name="pageNum"
		value="${myBoardPaging.pageNum}"> <input type="hidden"
		id="rowAmountPerPage" name="rowAmountPerPage"
		value="${myBoardPaging.rowAmountPerPage}"> <input
		type="hidden" id="scope" name="scope" value="${myBoardPaging.scope}">
	<input type="hidden" id="keyword" name="keyword"
		value="${myBoardPaging.keyword}"> <input type="hidden"
		id="startDate" name="startDate" value="${myBoardPaging.startDate}">
	<input type="hidden" id="endDate" name="endDate"
		value="${myBoardPaging.endDate}"> <input type="hidden"
		id="bno" name="bno" value='<c:out value="${myBoard.bno}"/>'>
</form>

<script>
<%-- 헤더, 토큰 --%>
var myCsrfHeaderName = "${_csrf.headerName}";
var myCsrfToken = "${_csrf.token}";
$(document).ajaxSend(function(e,xhr,options){
	xhr.setRequestHeader( myCsrfHeaderName, myCsrfToken);
});
</script>

<script>

	var frmSendValue = $("#frmSendValue");

	$("#btnToModify").on("click", function() {
		// location.href="${contextPath }/myboard/modify?bno=${board.bno }"
		frmSendValue.attr("action", "${contextPath}/myboard/modify");
		frmSendValue.attr("method", "get")

		frmSendValue.submit();

	});

	$("#btnToList").on("click", function() {
		// location.href="${contextPath }/myboard/list"

		frmSendValue.find("#bno").remove();
		frmSendValue.attr("action", "${contextPath}/myboard/list");
		frmSendValue.attr("method", "get")

		frmSendValue.submit();
	});

	function checkValue(event) {
		var btitle = document.querySelector("[name='btitle']");
		var bcontent = document.querySelector("[name='bcontent']");
		var bwriter = document.querySelector("[name='bwriter']");

		if (!btitle.value.trim()) {
			event.preventDefault();
			alert("글제목을 입력하십시오.");
			btitle.focus();
			return false;
		}

		if (!bcontent.value.trim()) {
			event.preventDefault();
			alert("글내용을 입력하십시오.");
			bcontent.focus();
			return false;
		}

		if (!bwriter.value.trim()) {
			event.preventDefault();
			alert("작성자를 입력하십시오.");
			bwriter.focus();
			return false;
		}
	}

	var result = '<c:out value="${result}"/>';

	function runModal(result) {
		var myMsg;

		if (!result) {
			return;
		} else {
			myMsg = "게시글이 수정되었습니다.";
		}
		$("#my-modal-body").html(myMsg);

		$("#myModal").modal("show");

		myMsg = "";
	}

	$(".attachLi")
			.on(
					"click",
					function() {
						var attachLi = $(this);
						var fileName = attachLi.data("repopath") + "/"
								+ attachLi.data("uploadpath") + "/"
								+ attachLi.data("uuid") + "_"
								+ attachLi.data("filename");

						var fileType = attachLi.data("filetype");

						if (fileType == "I") {
							$("#attachModal-body").html(
									'<img src="${contextPath}/doFileDownloadAjax?fileName='
											+ encodeURI(fileName)
											+ '" style="width:100%"/>');
							$("#attachModal").modal("show");
						} else {
							location.href = "${contextPath}/doFileDownloadAjax?fileName="
									+ encodeURI(fileName);
						}
					});

	$("#attachModal").on("click", function() {
		$("#attachModal").modal("hide");
	});
	
</script>

<%-- 댓글 답글 처리 시작 --%>
<script src="${contextPath}/resources/js/myreply.js"></script>
	
<script>
var commentUL = $(".commentUL");
var frmCmtPagingValue = $(".frmCmtPagingValue");
var bno = '<c:out value="${myBoard.bno}"/>'; 
var pageNum = 1;


<%-- 댓글 페이징 번호 표시 --%>
function showCmtPagingNums(rowTotal, pageNum, rowAmountPerPage) {
	
	var pagingNumCnt = 3;
	var endPagingNum = Math.ceil(pageNum/pagingNumCnt) * pagingNumCnt;
	var startPagingNum = endPagingNum - (pagingNumCnt - 1);
	
	var lastPagingNum = Math.ceil(rowTotal/rowAmountPerPage);
	var showCmtPagingNums = $("#showCmtPagingNums");
	
	if (lastPagingNum < endPagingNum) {
		endPagingNum = lastPagingNum;
	}
	
	var prev = startPagingNum > 1;
	var next = endPagingNum < lastPagingNum;
	
	var pagingShowHTML 
		= '<div style="text-align:center;">'
		+ '		<ul class="pagination pagination-sm">';
		
	if (prev) {
		pagingShowHTML
		+='			<li class="paginate_button previous" tabindex="0">'
		+ '				<a href="1"><span aria-hidden="true">&laquo;</span></a>'
		+ '    		</li>';
		+ '			<li class="paginate_button previous" tabindex="0">'
		+ '				<a href="' + (startPagingNum - 1) + '">Previous</a>'
		+ '    		</li>';
	}
	for (var i = startPagingNum; i <= endPagingNum; i++) {
		var active = (pageNum == i) ? "active" : "";
		pagingShowHTML
		+='			<li class="paginate_button ' + active + '" tabindex="0">'
		+ '				<a href="' + i + '">' + i + '</a>'
    	+ '			</li>';
	}
	if (next) {
		pagingShowHTML
		+='			<li class="paginate_button next" tabindex="0">'
		+ '				<a href="' + (endPagingNum + 1) + '">Next</a>'
		+ '    		</li>'
		+ '			<li class="paginate_button next" tabindex="0">'
		+ '				<a href="'+ lastPagingNum +'"><span aria-hidden="true">&raquo;</span></a>'
		+ '    		</li>';
	}
		pagingShowHTML
		+='		</ul>'
		+ '</div>' ; 
		showCmtPagingNums.html(pagingShowHTML);
} 

<%-- 선택된 페이징 번호 클릭 시, 댓글목록 가져오는 함수: 이벤트 전파 이용 --%>
$("#showCmtPagingNums").on("click", "div ul li a",function(e){
	e.preventDefault();
	pageNum = $(this).attr("href");
	showCmtList(pageNum);
});


<%-- 댓글 목록 표시 함수 --%>
function showCmtList(pageNum){
	myCommentModule.getReplyList(
		{bno: bno, pageNum: pageNum }, // pageNum: pageNum = undifined라면 1을 대입		
		
		function(myReplyPagingCreator){
			var resultHTML= "";
			for(var myReply of myReplyPagingCreator.myReplyList){
				resultHTML
				+= '<li class="left clearfix commentLi" data-bno="' + myReply.bno + '" data-rno="' + myReply.rno + '">' ;
				if (myReply.lvl == 1) {
					resultHTML +='<div>';
				} else {
					resultHTML +='<div style ="margin-left:' + (myReply.lvl * 25) + 'px">';
				}
				
				if (myReply.rdelFlag == 1) {
					resultHTML 
					+='     <div><Strong>관리자에 의해 블라인드된 댓글입니다.</Strong></div><br>'
				} else {
				resultHTML
				+='			<div>'
				+ '				<span class="header info-rwriter"> ' 
				if (myReply.lvl == 1) {
					resultHTML +='<strong class="primary-font">' + myReply.rwriter + '</strong>';
				} else {
					resultHTML +='<strong class="primary-font">'+ '<i class="fa fa-share fa-flip-vertical re"></i>' + ' ' + myReply.rwriter + '</strong>';	
				}
				resultHTML				 
				+='					<span>&nbsp;</span> '
				+ '					<small class="text-muted">' + myCommentModule.myDateTimeFmt(myReply.rregDate) + '</small>'
				+ '			<button type="button" style="display: in-block"'
				+ '				class="btn btn-warning btn-xs btnChgReg btnModCmtP">수정</button>'
				+ '					</span>'
				+ '			<p style="white-space:pre;">' + myReply.rcontent + '</p>'
				+ '		</div>'
				+ '		<div class="btnsComment" style="margin-bottom: 10px">'
				+ '			<button type="button" style="display: in-block"'
				+ '				class="btn btn-primary btn-xs btnChgReg">답글 작성</button>'
				+ '			<button type="button" style="display: none"'
				+ '				class="btn btn-warning btn-xs btnRegCmt">답글 등록</button>' 
				+ '			<button type="button" style="display: none"' 
				+ '				class="btn btn-warning btn-xs btnModCmt">답글 수정</button>'
				+ '			<button type="button" style="display: none"' 
				+ '				class="btn btn-warning btn-xs btnBlindCmt">블라인드</button>'
				+ '			<button type="button" style="display: none"' 
				+ '				class="btn btn-warning btn-xs btnDelCmt">삭제</button>'
				+ '			<button type="button" class="btn btn-warning btn-xs btnCansle" style="display: none">❌</button>'	
				+ '			<button type="button" class="btn btn-warning btn-xs btnCansle2" style="display: none">❌</button>'		
				+ '			<hr class="txtBoxCmtHr"'
				+ '				style="margin-top: 10px; margin-bottom: 10px">'
				+ '			<textarea class="form-control txtBoxCmtMod" name="rcontent"'
				+ '				style="margin-bottom: 10px; display:none;"'
				+ '				placeholder="답글작성을 원하시면,&#10;답글 작성  버튼을 클릭해주세요."></textarea>'
				+ '			</div>';
				}
				resultHTML
				+='		</div>'
				+ '	</li>	';
				
			}<%-- for-end --%> 
			
			commentUL.html(resultHTML);
			
			showCmtPagingNums(myReplyPagingCreator.rowTotal, 
							  myReplyPagingCreator.myReplyPaging.pageNum, 
							  myReplyPagingCreator.myReplyPaging.rowAmountPerPage);
	
		},
		
		function(err){
			console.log("오류: err: \n" + err);	
			
		}
	);
}

<%-- 댓글 등록 버튼 클릭처리 --%> 
$('#btnChgCmtReg').on('click', function() {
    $('#btnRegCmt').show();
    $('#btnCancelRegCmt').show();
    $(this).hide();
    $(".txtBoxCmt").attr("placeholder","").attr("readonly",false).focus();
});

$('#btnCancelRegCmt').on('click', function() {
    $('#btnRegCmt').hide();
    $('#btnCancelRegCmt').hide();
    $('#btnChgCmtReg').show();
    $(".txtBoxCmt").val("").attr("placeholder","댓글작성을 원하시면,\n댓글 작성 버튼을 클릭해주세요.").attr("readonly",true);
});

$(document).on('click','.btnChgReg' , function() {
	$(this).hide();
    $(this).siblings('.txtBoxCmtMod').show().focus();
    $(this).siblings('.btnCansle').show();
    $(this).siblings('.btnRegCmt').show();
});

$(document).on('click','.btnCansle' , function() {
	$(this).hide();
    $(this).siblings('.txtBoxCmtMod').hide();
    $(this).siblings('.btnRegCmt').hide();
    $(this).siblings('.btnChgReg').show();
});

$(document).on('click','.btnCansle2' , function() {
	var commentLi = $(this).closest('.commentLi');
	
	$(this).hide();
    $(this).siblings('.txtBoxCmtMod').hide();
    $(this).siblings('.btnRegCmt').hide();
    $(this).siblings('.btnChgReg').show();
    commentLi.find('.btnModCmtP').show();
    commentLi.find(".btnModCmt").hide();
    commentLi.find(".btnDelCmt").hide();
    commentLi.find(".btnBlindCmt").hide();
});

$(document).on('click','.btnModCmtP' , function() {
	var commentLi = $(this).closest('.commentLi');
	var replyContent = commentLi.find("p").text();
	
	commentLi.find(".btnChgReg").hide();
	commentLi.find(".btnModCmt").show();
	commentLi.find(".btnCansle2").show();
	commentLi.find(".btnBlindCmt").show();
	commentLi.find(".btnDelCmt").show();
	commentLi.find(".txtBoxCmtMod").val(replyContent).show();
});

<%-- 댓글 등록 처리 --%>
$('#btnRegCmt').on("click",function(){
	var rcontent = $(".txtBoxCmt").val();
	var rwriter = "user1";
	var comment = {bno: bno, rcontent: rcontent, rwriter: rwriter};
	
	myCommentModule.registerComment(
			comment,
			function(result){
				if(result != null){
					alert(result + "번 댓글이 등록되었습니다." );
				} else {
					alert("댓글 등록에 실패하였습니다.");
				}
				$(".txtBoxCmt").val("");
				showCmtList(pageNum);
			}
	);
});

<%-- 답글 등록 처리 --%>
$(document).on("click", ".btnRegCmt", function() {
	var commentLi = $(this).closest('.commentLi');
    var rcontent = commentLi.find(".txtBoxCmtMod").val();
    var prno = commentLi.data("rno");
    var rwriter = "user1";
    var comment = {bno: bno, rcontent: rcontent, rwriter: rwriter, prno: prno };
    
    myCommentModule.registerReply(
            comment,
            function(result) {
                if (result != null) {
                    alert(result + "답글이 등록되었습니다.");
                } else {
                    alert("답글 등록에 실패하였습니다.");
                }
                showCmtList(pageNum);
            }
        );
});

<%-- 답글 수정 처리 --%>
$(document).on("click", ".btnModCmt", function() {
	var commentLi = $(this).closest('.commentLi');
    var rcontent = commentLi.find(".txtBoxCmtMod").val();
    var rno = commentLi.data("rno");
    var comment = { bno: bno, rno: rno, rcontent: rcontent };

    myCommentModule.updateComment(
        comment,
        function(result) {
        	if (result != null) {
        		alert("댓글이 수정되었습니다.");
            } else {
            	alert("댓글이 수정에 실패했습니다.");
            }
        	selectReply(rcontent , rno);
        	// showCmtList(pageNum);
        }
    );
});

<%-- 댓글 및 답글 블라인드 처리 --%>

$(document).on("click", ".btnBlindCmt", function() {
    var commentLi = $(this).closest('.commentLi');
    var rno = commentLi.data("rno");
    var comment = {rno: rno, bno:bno};

    myCommentModule.blindComment(
        comment,
        function(result) {
        	if (result != null) {
        		alert("블라인드 처리 되었습니다.");
            } else {
            	alert("댓글이 수정에 실패했습니다.");
            }
            showCmtList(pageNum);
        }
    );
});

<%-- 댓글 및 답글 삭제 처리 --%>
$(document).on("click", ".btnDelCmt", function() {
	var commentLi = $(this).closest('.commentLi');
    var rno = commentLi.data("rno");
    var comment = {rno: rno, bno:bno};

    myCommentModule.deleteComment(
        comment,
        function(result) {
        	if (result != null) {
        		alert("삭제 처리 되었습니다.");
            } else {
            	alert("댓글이 수정에 실패했습니다.");
            }
            showCmtList(pageNum);
        }
    );
});

<%-- 특정 댓글,답글 조회 --%>
function selectReply(rcontent, rno) {
    if (rcontent) {
        $.ajax({
            type: 'GET',
            url: "/mypro00/replies/" + bno + "/" + rno,
            success: function(result) {
                var commentLi = $('li.commentLi[data-rno=' + rno + ']');
                commentLi.find('p').text(rcontent);
                
                commentLi.find('.btnChgReg').show();
                commentLi.find('.btnModCmtP').show();
                commentLi.find(".btnModCmt").hide();
                commentLi.find(".btnCansle2").hide();
                commentLi.find(".btnDelCmt").hide();
                commentLi.find(".btnBlindCmt").hide();
                commentLi.find(".txtBoxCmtMod").hide();
            }
        });
    }
}


    
</script>

<script>
	<%-- document.ready는 맨아래 --%>
	$(document).ready(function() {
		showCmtList(1);
		runModal(result);
	});
</script>

<%@ include file="../myinclude/myfooter.jsp"%>