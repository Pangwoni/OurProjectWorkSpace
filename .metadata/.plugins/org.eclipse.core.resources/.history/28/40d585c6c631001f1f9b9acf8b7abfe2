<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.spring5legacy.mypro00.mapper.MyReplyMapper">

<!-- 특정 게시물의 댓글/답글 목록 조회 (Paging) -->
	<select id="selectReplyList" resultType="com.spring5legacy.mypro00.domain.MyReplyVO">
	<![CDATA[
		SELECT RN, LVL, RNO, PRNO, BNO, RREGDATE, RCONTENT, RWRITER, RMODDATE, RDELFLAG
		FROM ( WITH reply (LVL, RNO, PRNO, BNO, RREGDATE, RCONTENT, RWRITER, RMODDATE, RDELFLAG) 
			AS (SELECT 1 LVL, A.RNO, A.PRNO, A.BNO, A.RREGDATE, A.RCONTENT, A.RWRITER, A.rMODDATE, A.RDELFLAG
	            FROM myuser.tbl_myreply A
	            WHERE A.bno = #{bno} AND A.PRNO IS NULL
	            UNION ALL 
	            SELECT A.LVL + 1, B.RNO, B.PRNO, B.BNO, B.RREGDATE, B.RCONTENT, B.RWRITER, B.RMODDATE, B.RDELFLAG
	            FROM reply A JOIN (SELECT * FROM myuser.tbl_myreply c WHERE c.bno = #{bno}) B ON B.PRNO = A.RNO
		        )
		    SEARCH DEPTH FIRST BY RNO DESC SET mySort
	        SELECT ROWNUM RN, LVL, RNO, PRNO, BNO, RREGDATE, RCONTENT, RWRITER, RMODDATE, RDELFLAG
	        FROM reply
	        WHERE ROWNUM <= (#{pageNum} * #{rowAmountPerPage})
	        ORDER BY mySort )
		WHERE RN >= ((#{pageNum} * #{rowAmountPerPage}) - (#{rowAmountPerPage} - 1))
	]]>
	</select>
	
<!-- 특정 게시물에 대한 댓글 총 갯수 -->
	<select id="selectReplyTotal" resultType="Long">
		SELECT count(*) FROM myuser.tbl_myreply WHERE bno = #{bno}
	</select>
	
<!-- 특정 게시물에 대한 댓글 등록  -->
	<insert id="insertComment" parameterType="com.spring5legacy.mypro00.domain.MyReplyVO">
		<selectKey keyProperty="rno" order="BEFORE" resultType="Long">
			SELECT myuser.seq_myreply.NEXTVAL FROM dual
		</selectKey>
		INSERT INTO myuser.tbl_myReply
		VALUES (#{rno}, #{rcontent}, #{rwriter}, DEFAULT, DEFAULT, #{bno}, DEFAULT, DEFAULT)
	</insert>
	
<!-- 특정 댓글에 대한 답글 등록  -->
	<insert id="insertReply" parameterType="com.spring5legacy.mypro00.domain.MyReplyVO" >
		<selectKey keyProperty="rno" order="BEFORE" resultType="Long">
			SELECT myuser.seq_myreply.NEXTVAL FROM dual
		</selectKey>
		INSERT INTO myuser.tbl_myReply
		VALUES (#{rno}, #{rcontent}, #{rwriter}, DEFAULT, DEFAULT, #{bno}, #{prno}, DEFAULT)
	</insert>
	
<!-- 특정 댓글 및 답글에 대한 수정 -->
	 <update id="updateCommentAndReply">
        UPDATE myuser.tbl_myreply
        SET rcontent = #{rcontent}, rmodDate = DEFAULT
        WHERE rno = #{rno}
    </update>
    
<!-- 특정 댓글 및 답글에 대한 블라인드 처리 -->
	 <update id="updateSetBlind">
        UPDATE myuser.tbl_myreply
        SET RDELFLAG = 1
        WHERE rno = #{rno}
    </update>
    
<!-- 특정 댓글 및 답글 한번에 삭제 -->
	<delete id="deleteReplies">
        DELETE FROM tbl_myreply
        WHERE rno IN (
            SELECT rno
            FROM tbl_myreply
            START WITH rno = #{rno}
            CONNECT BY PRIOR rno = prno
        )
    </delete>
    
<!-- 특정 답글 조회 --><!-- 
    <select id="selectReply" parameterType="Long" resultType="com.spring5legacy.mypro00.domain.MyReplyVO">
        SELECT rno, rcontent, rwriter, rRegDate, rModDate, bno, prno, rdelFlag
        FROM tbl_myreply
        WHERE rno = #{rno}
    </select> -->
    
</mapper>