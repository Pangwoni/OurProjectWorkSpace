<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.spring5legacy.mypro00.mapper.MyReplyMapper">

<!-- 특정 게시물의 댓글/답글 목록 조회 (Paging) -->
	<select id="selectReplyList" resultType="com.spring5legacy.mypro00.domain.MyReplyVO">
	<![CDATA[
		SELECT RN, LVL, RNO, PRNO, BNO, RREGDATE, RCONTENT, RWRITER, RMODDATE, RDELFLAG
		FROM ( WITH reply (LVL, RNO, PRNO, BNO, RREGDATE, RCONTENT, RWRITER, RMODDATE, RDELFLAG) 
			AS (SELECT 1 LVL, A.RNO, A.PRNO, A.BNO, A.RREGDATE, A.RCONTENT, A.RWRITER, A.rMODDATE, A.RDELFLAG
	            FROM myuser.tbl_myreply A
	            WHERE A.bno = #{bno} AND A.PRNO IS NULL
	            UNION ALL 
	            SELECT A.LVL + 1, B.RNO, B.PRNO, B.BNO, B.RREGDATE, B.RCONTENT, B.RWRITER, B.RMODDATE, B.RDELFLAG
	            FROM reply A JOIN (SELECT * FROM myuser.tbl_myreply c WHERE c.bno = #{bno}) B ON B.PRNO = A.RNO
		        )
		    SEARCH DEPTH FIRST BY RNO ASC SET mySort
	        SELECT ROWNUM RN, LVL, RNO, PRNO, BNO, RREGDATE, RCONTENT, RWRITER, RMODDATE, RDELFLAG
	        FROM reply
	        WHERE ROWNUM <= (#{pageNum} * #{rowAmountPerPage})
	        ORDER BY mySort )
		WHERE RN >= ((#{pageNum} * #{rowAmountPerPage}) - (#{rowAmountPerPage} - 1))
	]]>
	</select>
	
<!-- 특정 게시물에 대한 댓글 총 갯수 -->
	<select id="selectReplyTotal" resultType="Long">
		SELECT count(*) FROM myuser.tbl_myreply WHERE bno = #{bno}
	</select>
	
<!-- 특정 게시물에 대한 댓글 등록  -->
	<insert id="insertComment" parameterType="com.spring5legacy.mypro00.domain.MyReplyVO">
		<selectKey keyProperty="rno" order="BEFORE" resultType="LNO">
			SELECT myuser.seq_myreply.NEXTVAL FROM deal
		</selectKey>
		INSERT INTO myuser.tbl_myReply
		VALUES (#{rno}, #{rcontent}, #{rwriter}, DEFAULT, DEFAULT, #{bno}, DEFAULT, DEFAULT)
	</insert>
	
	
</mapper>